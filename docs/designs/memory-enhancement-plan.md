# Agent Zero è®°å¿†ç³»ç»Ÿå¢å¼ºå¼€å‘è®¡åˆ’

> **ç‰ˆæœ¬**: 1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-30  
> **ç›®æ ‡**: å°† OpenClaw çš„å…ˆè¿›è®°å¿†ç®¡ç†æŠ€æœ¯ç§»æ¤åˆ° Agent Zeroï¼Œæå‡å…¶è®°å¿†æ£€ç´¢è´¨é‡å’Œä¼šè¯ç®¡ç†èƒ½åŠ›

---

## ğŸ“‹ ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
- [2. æŠ€æœ¯å¯¹æ¯”åˆ†æ](#2-æŠ€æœ¯å¯¹æ¯”åˆ†æ)
- [3. æ•´ä½“æ¶æ„è®¾è®¡](#3-æ•´ä½“æ¶æ„è®¾è®¡)
- [4. åˆ†é˜¶æ®µå®æ–½è®¡åˆ’](#4-åˆ†é˜¶æ®µå®æ–½è®¡åˆ’)
- [5. æ¨¡å—è¯¦ç»†è®¾è®¡](#5-æ¨¡å—è¯¦ç»†è®¾è®¡)
- [6. æµ‹è¯•ä¸éªŒæ”¶æ ‡å‡†](#6-æµ‹è¯•ä¸éªŒæ”¶æ ‡å‡†)
- [7. é£é™©è¯„ä¼°ä¸ç¼“è§£](#7-é£é™©è¯„ä¼°ä¸ç¼“è§£)
- [8. åç»­ä¼˜åŒ–æ–¹å‘](#8-åç»­ä¼˜åŒ–æ–¹å‘)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 èƒŒæ™¯

Agent Zero æ˜¯ä¸€ä¸ªé€šç”¨å‹è‡ªä¸» AI ä»£ç†æ¡†æ¶ï¼Œå…·æœ‰å¼ºå¤§çš„ä»£ç æ‰§è¡Œå’Œå¤šä»£ç†åä½œèƒ½åŠ›ã€‚OpenClaw æ˜¯ä¸€ä¸ªå¤šæ¸ é“ AI åŠ©æ‰‹å¹³å°ï¼Œåœ¨è®°å¿†ç®¡ç†å’Œæ£€ç´¢æ–¹é¢æœ‰ç‹¬ç‰¹çš„æŠ€æœ¯ä¼˜åŠ¿ã€‚

æœ¬é¡¹ç›®æ—¨åœ¨å°† OpenClaw åœ¨è®°å¿†ç³»ç»Ÿæ–¹é¢çš„æŠ€æœ¯ä¼˜åŠ¿ç§»æ¤åˆ° Agent Zeroï¼ŒåŒæ—¶ä¿ç•™ Agent Zero ç°æœ‰çš„æ™ºèƒ½è®°å¿†åˆå¹¶ (Memory Consolidation) åŠŸèƒ½ã€‚

### 1.2 é¡¹ç›®ç›®æ ‡

| ç›®æ ‡ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| æ··åˆæ£€ç´¢ | å®ç°å‘é‡ + å…³é”®è¯æ··åˆæ£€ç´¢ï¼Œæå‡å¬å›ç‡ | â­â­â­â­â­ |
| ä¼šè¯æŒä¹…åŒ– | æ”¯æŒä¼šè¯å†å²çš„æŒä¹…åŒ–å­˜å‚¨å’Œè¯­ä¹‰æ£€ç´¢ | â­â­â­â­ |
| å®æ—¶ç´¢å¼• | æ–‡ä»¶ç›‘æ§ï¼ŒçŸ¥è¯†å˜æ›´è‡ªåŠ¨è§¦å‘ç´¢å¼•æ›´æ–° | â­â­â­ |
| Embedding ç¼“å­˜ | å‡å°‘é‡å¤ Embedding è®¡ç®—ï¼Œé™ä½ API æˆæœ¬ | â­â­â­â­ |
| å¢é‡åŒæ­¥ | åŸºäº Hash çš„å¢é‡åŒæ­¥ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡æ–°ç´¢å¼• | â­â­â­â­ |

### 1.3 é¢„æœŸæ”¶ç›Š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é¢„æœŸæ•ˆæœå¯¹æ¯”                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      èƒ½åŠ›        â”‚   æ”¹é€ å‰    â”‚        æ”¹é€ å           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ£€ç´¢è´¨é‡        â”‚  çº¯è¯­ä¹‰ 70%  â”‚ æ··åˆæ£€ç´¢ 90%+          â”‚
â”‚ ç²¾ç¡®åŒ¹é…        â”‚  âŒ ä¸æ”¯æŒ   â”‚ âœ… FTS5 å…¨æ–‡æœç´¢       â”‚
â”‚ ä¼šè¯æ£€ç´¢        â”‚  âŒ æ—        â”‚ âœ… è¯­ä¹‰æœç´¢å†å²ä¼šè¯    â”‚
â”‚ ç´¢å¼•æ›´æ–°        â”‚  å¯åŠ¨æ—¶é¢„åŠ è½½â”‚ âœ… å®æ—¶æ–‡ä»¶ç›‘æ§        â”‚
â”‚ API æˆæœ¬        â”‚  æ¯æ¬¡è®¡ç®—    â”‚ âœ… ç¼“å­˜å¤ç”¨ (-60%)     â”‚
â”‚ è®°å¿†åˆå¹¶        â”‚  âœ… å·²æœ‰     â”‚ âœ… ä¿ç•™å¹¶å¢å¼º          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æŠ€æœ¯å¯¹æ¯”åˆ†æ

### 2.1 å½“å‰ Agent Zero è®°å¿†ç³»ç»Ÿ

```
python/helpers/
â”œâ”€â”€ memory.py                 # æ ¸å¿ƒè®°å¿†ç®¡ç†
â”œâ”€â”€ memory_consolidation.py   # æ™ºèƒ½è®°å¿†åˆå¹¶
â””â”€â”€ knowledge_import.py       # çŸ¥è¯†å¯¼å…¥

å…³é”®ç‰¹ç‚¹:
- å‘é‡å­˜å‚¨: FAISS (IndexFlatIP, ä½™å¼¦ç›¸ä¼¼åº¦)
- Embedding: LangChain + LiteLLM (å¤š Provider)
- çŸ¥è¯†åˆ†åŒº: MAIN, FRAGMENTS, SOLUTIONS, INSTRUMENTS
- æ™ºèƒ½åˆå¹¶: MERGE, REPLACE, UPDATE, KEEP_SEPARATE, SKIP
```

### 2.2 OpenClaw è®°å¿†ç³»ç»Ÿä¼˜åŠ¿

```
src/memory/
â”œâ”€â”€ manager.ts                # è®°å¿†ç®¡ç†å™¨ (2200+ è¡Œ)
â”œâ”€â”€ embeddings.ts             # Embedding æä¾›è€…
â”œâ”€â”€ hybrid.ts                 # æ··åˆæ£€ç´¢
â”œâ”€â”€ batch-openai.ts           # æ‰¹é‡ Embedding
â””â”€â”€ session-files.ts          # ä¼šè¯æ–‡ä»¶ç®¡ç†

å…³é”®ä¼˜åŠ¿:
- æ··åˆæ£€ç´¢: å‘é‡ (sqlite-vec) + å…³é”®è¯ (FTS5)
- èåˆç®—æ³•: RRF (Reciprocal Rank Fusion)
- ä¼šè¯ç´¢å¼•: è‡ªåŠ¨ç´¢å¼•ä¼šè¯å†å²
- æ–‡ä»¶ç›‘æ§: chokidar å®æ—¶ç›‘æ§
- å¢é‡åŒæ­¥: Hash-based å˜æ›´æ£€æµ‹
- Embedding ç¼“å­˜: SQLite æŒä¹…åŒ–ç¼“å­˜
```

### 2.3 æŠ€æœ¯å·®è·åˆ†æ

| æŠ€æœ¯ç‚¹ | Agent Zero | OpenClaw | å·®è· |
|--------|------------|----------|------|
| å‘é‡æ£€ç´¢ | âœ… FAISS | âœ… sqlite-vec | å¹³æ‰‹ |
| å…³é”®è¯æ£€ç´¢ | âŒ æ—  | âœ… FTS5 | ğŸ”´ ç¼ºå¤± |
| æ··åˆæ’åº | âŒ æ—  | âœ… RRF | ğŸ”´ ç¼ºå¤± |
| ä¼šè¯æŒä¹…åŒ– | âŒ æ—  | âœ… JSONL + ç´¢å¼• | ğŸ”´ ç¼ºå¤± |
| æ–‡ä»¶ç›‘æ§ | âŒ æ—  | âœ… chokidar | ğŸ”´ ç¼ºå¤± |
| å¢é‡åŒæ­¥ | âŒ å…¨é‡ | âœ… Hash-based | ğŸ”´ ç¼ºå¤± |
| Embedding ç¼“å­˜ | âœ… æ–‡ä»¶ç³»ç»Ÿ | âœ… SQLite | ğŸŸ¡ å¯ä¼˜åŒ– |
| è®°å¿†åˆå¹¶ | âœ… LLM æ™ºèƒ½ | âŒ æ—  | ğŸŸ¢ Agent Zero ä¼˜åŠ¿ |

---

## 3. æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EnhancedMemorySystem                            â”‚
â”‚                        (ç»Ÿä¸€å…¥å£)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚                       â”‚
        â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HybridMemory  â”‚      â”‚SessionManager â”‚      â”‚MemoryWatcher  â”‚
â”‚ (æ··åˆæ£€ç´¢)    â”‚      â”‚ (ä¼šè¯ç®¡ç†)    â”‚      â”‚ (æ–‡ä»¶ç›‘æ§)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚                      â”‚
        â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FAISSå‘é‡åº“   â”‚      â”‚ JSONLä¼šè¯æ–‡ä»¶ â”‚      â”‚  watchdog     â”‚
â”‚ FTS5å…¨æ–‡ç´¢å¼•  â”‚      â”‚ ä¼šè¯å‘é‡ç´¢å¼•  â”‚      â”‚  (OSäº‹ä»¶)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚MemoryConsoli- â”‚
           â”‚   dator       â”‚
           â”‚ (æ™ºèƒ½åˆå¹¶)    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚EmbeddingCache â”‚
           â”‚ (SQLiteç¼“å­˜)  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ–‡ä»¶ç»“æ„è§„åˆ’

```
python/helpers/
â”œâ”€â”€ memory.py                    # ç°æœ‰ (ä¿æŒå…¼å®¹, å°ä¿®æ”¹)
â”œâ”€â”€ memory_consolidation.py      # ç°æœ‰ (ä¿ç•™)
â”œâ”€â”€ memory_hybrid.py             # ğŸ†• æ··åˆæ£€ç´¢
â”œâ”€â”€ memory_fts.py                # ğŸ†• FTS5 å…¨æ–‡æœç´¢
â”œâ”€â”€ memory_session.py            # ğŸ†• ä¼šè¯æŒä¹…åŒ–
â”œâ”€â”€ memory_watcher.py            # ğŸ†• æ–‡ä»¶ç›‘æ§
â”œâ”€â”€ memory_cache.py              # ğŸ†• Embedding ç¼“å­˜
â”œâ”€â”€ memory_sync.py               # ğŸ†• å¢é‡åŒæ­¥
â””â”€â”€ memory_enhanced.py           # ğŸ†• ç»Ÿä¸€å…¥å£

prompts/default/
â”œâ”€â”€ memory.hybrid_search.sys.md  # ğŸ†• æ··åˆæœç´¢ç³»ç»Ÿæç¤º
â””â”€â”€ memory.session_summary.md    # ğŸ†• ä¼šè¯æ‘˜è¦æç¤º

memory/
â”œâ”€â”€ default/
â”‚   â”œâ”€â”€ index.faiss              # ç°æœ‰å‘é‡ç´¢å¼•
â”‚   â”œâ”€â”€ fts.db                   # ğŸ†• FTS5 ç´¢å¼•
â”‚   â”œâ”€â”€ cache.db                 # ğŸ†• Embedding ç¼“å­˜
â”‚   â””â”€â”€ sessions/                # ğŸ†• ä¼šè¯æ–‡ä»¶ç›®å½•
â”‚       â”œâ”€â”€ session_001.jsonl
â”‚       â””â”€â”€ session_002.jsonl
â””â”€â”€ embeddings/                  # ç°æœ‰ Embedding ç¼“å­˜ç›®å½•
```

### 3.3 æ•°æ®æµè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å†™å…¥æµç¨‹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·/Agent ä¿å­˜è®°å¿†
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ£€æŸ¥ Embedding â”‚
â”‚    ç¼“å­˜       â”‚â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ å‘½ä¸­
        â”‚ æœªå‘½ä¸­        â–¼
        â–¼          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ ç›´æ¥ä½¿ç”¨ç¼“å­˜  â”‚
â”‚è®¡ç®— Embedding â”‚  â”‚   çš„å‘é‡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°ç¼“å­˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®°å¿†åˆå¹¶åˆ†æ  â”‚ (MemoryConsolidator)
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å†™å…¥ FAISS    â”‚               â”‚ å†™å…¥ FTS5     â”‚
â”‚   å‘é‡åº“      â”‚               â”‚  å…¨æ–‡ç´¢å¼•     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ£€ç´¢æµç¨‹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœç´¢è¯·æ±‚ (query)
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é‡æ£€ç´¢      â”‚                 â”‚ å…³é”®è¯æ£€ç´¢    â”‚
â”‚ (FAISS)       â”‚                 â”‚ (FTS5 BM25)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  RRF èåˆæ’åº  â”‚
             â”‚ (Reciprocal   â”‚
             â”‚  Rank Fusion) â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  è¿”å›ç»“æœ     â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### 4.1 é˜¶æ®µæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ 1: åŸºç¡€è®¾æ–½ (2å¤©)                                              â”‚
â”‚  â”œâ”€ Embedding ç¼“å­˜ (SQLite)                                         â”‚
â”‚  â””â”€ å¢é‡åŒæ­¥åŸºç¡€è®¾æ–½                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é˜¶æ®µ 2: æ··åˆæ£€ç´¢ (3å¤©)                                              â”‚
â”‚  â”œâ”€ FTS5 å…¨æ–‡ç´¢å¼•                                                    â”‚
â”‚  â”œâ”€ RRF èåˆç®—æ³•                                                     â”‚
â”‚  â””â”€ HybridMemory ç±»                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é˜¶æ®µ 3: ä¼šè¯ç®¡ç† (2å¤©)                                              â”‚
â”‚  â”œâ”€ ä¼šè¯æŒä¹…åŒ– (JSONL)                                               â”‚
â”‚  â”œâ”€ ä¼šè¯ç´¢å¼•                                                         â”‚
â”‚  â””â”€ ä¼šè¯æ£€ç´¢ API                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é˜¶æ®µ 4: å®æ—¶ç›‘æ§ (1å¤©)                                              â”‚
â”‚  â”œâ”€ watchdog æ–‡ä»¶ç›‘æ§                                                â”‚
â”‚  â””â”€ è‡ªåŠ¨å¢é‡ç´¢å¼•                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é˜¶æ®µ 5: æ•´åˆæµ‹è¯• (2å¤©)                                              â”‚
â”‚  â”œâ”€ EnhancedMemorySystem æ•´åˆ                                        â”‚
â”‚  â”œâ”€ å•å…ƒæµ‹è¯•                                                         â”‚
â”‚  â””â”€ é›†æˆæµ‹è¯•                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è®¡: 10 ä¸ªå·¥ä½œæ—¥
```

---

### 4.2 é˜¶æ®µ 1: åŸºç¡€è®¾æ–½ (Day 1-2)

#### 4.2.1 Embedding ç¼“å­˜æ¨¡å—

**ç›®æ ‡**: å‡å°‘é‡å¤ Embedding è®¡ç®—ï¼Œé™ä½ API æˆæœ¬

**æ–‡ä»¶**: `python/helpers/memory_cache.py`

```python
# æ ¸å¿ƒç±»è®¾è®¡
class EmbeddingCache:
    """
    SQLite-based Embedding ç¼“å­˜
    
    ç‰¹æ€§:
    - æŒä¹…åŒ–å­˜å‚¨ (SQLite)
    - LRU æ¸…ç†ç­–ç•¥
    - å¤š Provider/Model æ”¯æŒ
    - æ‰¹é‡æ“ä½œä¼˜åŒ–
    """
    
    def __init__(self, db_path: str, max_entries: int = 100000):
        pass
    
    def get(self, text: str, provider: str, model: str) -> Optional[List[float]]:
        """è·å–ç¼“å­˜çš„ embedding"""
        pass
    
    def get_batch(self, texts: List[str], provider: str, model: str) -> Dict[str, List[float]]:
        """æ‰¹é‡è·å–ç¼“å­˜"""
        pass
    
    def set(self, text: str, provider: str, model: str, embedding: List[float]):
        """ä¿å­˜ embedding"""
        pass
    
    def set_batch(self, items: List[Tuple[str, List[float]]], provider: str, model: str):
        """æ‰¹é‡ä¿å­˜"""
        pass
    
    def stats(self) -> Dict[str, Any]:
        """ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯"""
        pass
```

**æ•°æ®åº“ Schema**:

```sql
CREATE TABLE embedding_cache (
    hash TEXT PRIMARY KEY,          -- æ–‡æœ¬ SHA256 hash
    provider TEXT NOT NULL,         -- å¦‚ 'openai', 'gemini'
    model TEXT NOT NULL,            -- å¦‚ 'text-embedding-3-small'
    embedding BLOB NOT NULL,        -- float32 æ•°ç»„
    dims INTEGER NOT NULL,          -- å‘é‡ç»´åº¦
    created_at TEXT NOT NULL,
    accessed_at TEXT NOT NULL
);

CREATE INDEX idx_provider_model ON embedding_cache(provider, model);
CREATE INDEX idx_accessed ON embedding_cache(accessed_at);
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç¼“å­˜å‘½ä¸­æ—¶, Embedding è®¡ç®—æ—¶é—´ < 10ms
- [ ] ç¼“å­˜æœªå‘½ä¸­æ—¶, è‡ªåŠ¨å­˜å‚¨æ–°è®¡ç®—çš„ embedding
- [ ] LRU æ¸…ç†æ­£å¸¸å·¥ä½œ, ä¸è¶…è¿‡ max_entries

---

#### 4.2.2 å¢é‡åŒæ­¥æ¨¡å—

**ç›®æ ‡**: åŸºäº Hash çš„å˜æ›´æ£€æµ‹ï¼Œé¿å…é‡å¤ç´¢å¼•

**æ–‡ä»¶**: `python/helpers/memory_sync.py`

```python
class MemorySyncManager:
    """
    å¢é‡åŒæ­¥ç®¡ç†å™¨
    
    ç‰¹æ€§:
    - æ–‡ä»¶ Hash è¿½è¸ª
    - è„æ–‡ä»¶é˜Ÿåˆ—
    - æ‰¹é‡åŒæ­¥
    """
    
    def __init__(self, memory: Memory, state_db_path: str):
        pass
    
    def check_file_changed(self, filepath: str) -> bool:
        """æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å˜åŒ–"""
        pass
    
    def mark_synced(self, filepath: str, hash: str):
        """æ ‡è®°æ–‡ä»¶å·²åŒæ­¥"""
        pass
    
    async def sync_changed_files(self, files: List[str]) -> SyncResult:
        """åŒæ­¥å˜åŒ–çš„æ–‡ä»¶"""
        pass
```

**äº¤ä»˜ç‰©**:
- `memory_cache.py` - Embedding ç¼“å­˜
- `memory_sync.py` - å¢é‡åŒæ­¥
- å•å…ƒæµ‹è¯•æ–‡ä»¶

---

### 4.3 é˜¶æ®µ 2: æ··åˆæ£€ç´¢ (Day 3-5)

#### 4.3.1 FTS5 å…¨æ–‡ç´¢å¼•æ¨¡å—

**ç›®æ ‡**: å®ç°åŸºäº SQLite FTS5 çš„å…³é”®è¯æ£€ç´¢

**æ–‡ä»¶**: `python/helpers/memory_fts.py`

```python
class FTSIndex:
    """
    FTS5 å…¨æ–‡æœç´¢ç´¢å¼•
    
    ç‰¹æ€§:
    - Porter è¯å¹²æå–
    - Unicode æ”¯æŒ
    - BM25 æ’åº
    - é«˜äº®æ‘˜è¦
    """
    
    FTS_TABLE = "memory_fts"
    
    def __init__(self, db_path: str):
        pass
    
    def add_document(self, doc_id: str, content: str, metadata: dict):
        """æ·»åŠ æ–‡æ¡£åˆ°ç´¢å¼•"""
        pass
    
    def remove_document(self, doc_id: str):
        """ä»ç´¢å¼•åˆ é™¤æ–‡æ¡£"""
        pass
    
    def search(self, query: str, limit: int = 10, filter: str = "") -> List[FTSResult]:
        """æœç´¢æ–‡æ¡£"""
        pass
    
    def build_query(self, raw_query: str) -> str:
        """æ„å»º FTS5 æŸ¥è¯¢è¯­æ³•"""
        pass
```

**FTS5 è¡¨ç»“æ„**:

```sql
CREATE VIRTUAL TABLE memory_fts USING fts5(
    id,
    content,
    area,
    source_file,
    timestamp,
    tokenize='porter unicode61 remove_diacritics 2'
);
```

---

#### 4.3.2 RRF èåˆç®—æ³•

**ç›®æ ‡**: å®ç° Reciprocal Rank Fusion å¤šè·¯å¬å›èåˆ

**ç®—æ³•å…¬å¼**:
```
RRF_score(d) = Î£ (weight_i / (k + rank_i(d)))

å…¶ä¸­:
- d: æ–‡æ¡£
- weight_i: ç¬¬ i ä¸ªæ£€ç´¢å™¨çš„æƒé‡
- k: å¸¸æ•° (é€šå¸¸ä¸º 60)
- rank_i(d): æ–‡æ¡£ d åœ¨ç¬¬ i ä¸ªæ£€ç´¢å™¨ä¸­çš„æ’å
```

```python
def reciprocal_rank_fusion(
    vector_results: List[SearchResult],
    keyword_results: List[SearchResult],
    vector_weight: float = 0.7,
    text_weight: float = 0.3,
    k: int = 60
) -> List[SearchResult]:
    """
    RRF èåˆç®—æ³•
    
    Args:
        vector_results: å‘é‡æ£€ç´¢ç»“æœ
        keyword_results: å…³é”®è¯æ£€ç´¢ç»“æœ
        vector_weight: å‘é‡æƒé‡ (é»˜è®¤ 0.7)
        text_weight: å…³é”®è¯æƒé‡ (é»˜è®¤ 0.3)
        k: RRF å¸¸æ•° (é»˜è®¤ 60)
    
    Returns:
        èåˆæ’åºåçš„ç»“æœåˆ—è¡¨
    """
    pass
```

---

#### 4.3.3 HybridMemory ç±»

**ç›®æ ‡**: ç»Ÿä¸€çš„æ··åˆæ£€ç´¢æ¥å£

**æ–‡ä»¶**: `python/helpers/memory_hybrid.py`

```python
class HybridMemory(Memory):
    """
    æ··åˆæ£€ç´¢è®°å¿†ç³»ç»Ÿ
    
    ç»§æ‰¿è‡ª Memory, æ‰©å±•æ··åˆæ£€ç´¢èƒ½åŠ›
    """
    
    def __init__(
        self,
        db: MyFaiss,
        memory_subdir: str,
        fts_db_path: str,
        hybrid_config: HybridConfig = None
    ):
        super().__init__(db, memory_subdir)
        self.fts = FTSIndex(fts_db_path)
        self.config = hybrid_config or HybridConfig()
    
    async def insert_text(self, text: str, metadata: dict = {}) -> str:
        """æ’å…¥æ–‡æœ¬åˆ°å‘é‡åº“å’Œ FTS ç´¢å¼•"""
        # 1. è°ƒç”¨çˆ¶ç±»æ’å…¥å‘é‡
        doc_id = await super().insert_text(text, metadata)
        
        # 2. åŒæ­¥åˆ° FTS ç´¢å¼•
        self.fts.add_document(doc_id, text, metadata)
        
        return doc_id
    
    async def hybrid_search(
        self,
        query: str,
        limit: int = 10,
        threshold: float = 0.7,
        filter: str = ""
    ) -> List[Document]:
        """æ··åˆæ£€ç´¢"""
        pass
    
    async def delete_documents_by_ids(self, ids: List[str]):
        """åˆ é™¤æ–‡æ¡£ (åŒæ—¶ä»å‘é‡åº“å’Œ FTS)"""
        await super().delete_documents_by_ids(ids)
        for doc_id in ids:
            self.fts.remove_document(doc_id)


@dataclass
class HybridConfig:
    """æ··åˆæ£€ç´¢é…ç½®"""
    vector_weight: float = 0.7
    text_weight: float = 0.3
    rrf_k: int = 60
    candidate_multiplier: int = 3
    enable_fts: bool = True
```

**äº¤ä»˜ç‰©**:
- `memory_fts.py` - FTS5 ç´¢å¼•
- `memory_hybrid.py` - æ··åˆæ£€ç´¢
- å•å…ƒæµ‹è¯•æ–‡ä»¶

---

### 4.4 é˜¶æ®µ 3: ä¼šè¯ç®¡ç† (Day 6-7)

#### 4.4.1 ä¼šè¯æŒä¹…åŒ–

**ç›®æ ‡**: è‡ªåŠ¨ä¿å­˜å¯¹è¯å†å²ï¼Œæ”¯æŒæ£€ç´¢

**æ–‡ä»¶**: `python/helpers/memory_session.py`

```python
class SessionMemoryManager:
    """
    ä¼šè¯è®°å¿†ç®¡ç†å™¨
    
    ç‰¹æ€§:
    - JSONL æ ¼å¼å­˜å‚¨
    - å¢é‡ç´¢å¼•
    - è¯­ä¹‰æœç´¢
    - ä¼šè¯æ‘˜è¦ç”Ÿæˆ
    """
    
    def __init__(
        self,
        memory: Memory,
        sessions_dir: str,
        chunk_size: int = 10
    ):
        pass
    
    async def save_message(
        self,
        session_id: str,
        role: str,
        content: str,
        metadata: dict = {}
    ):
        """ä¿å­˜æ¶ˆæ¯åˆ°ä¼šè¯æ–‡ä»¶"""
        pass
    
    async def sync_sessions(self, force: bool = False):
        """åŒæ­¥ä¼šè¯æ–‡ä»¶åˆ°å‘é‡ç´¢å¼•"""
        pass
    
    async def search_sessions(
        self,
        query: str,
        limit: int = 5,
        session_id: Optional[str] = None
    ) -> List[SessionSearchResult]:
        """è¯­ä¹‰æœç´¢ä¼šè¯å†å²"""
        pass
    
    async def get_session_summary(self, session_id: str) -> str:
        """ç”Ÿæˆä¼šè¯æ‘˜è¦"""
        pass
```

**ä¼šè¯æ–‡ä»¶æ ¼å¼** (JSONL):

```json
{"role": "user", "content": "è¯·å¸®æˆ‘åˆ†æ...", "timestamp": "2026-01-30T21:00:00"}
{"role": "assistant", "content": "å¥½çš„ï¼Œæˆ‘æ¥åˆ†æ...", "timestamp": "2026-01-30T21:00:05"}
```

**äº¤ä»˜ç‰©**:
- `memory_session.py` - ä¼šè¯ç®¡ç†
- `prompts/default/memory.session_summary.md` - ä¼šè¯æ‘˜è¦æç¤º
- å•å…ƒæµ‹è¯•æ–‡ä»¶

---

### 4.5 é˜¶æ®µ 4: å®æ—¶ç›‘æ§ (Day 8)

#### 4.5.1 æ–‡ä»¶ç›‘æ§æ¨¡å—

**ç›®æ ‡**: å®æ—¶ç›‘æ§çŸ¥è¯†åº“æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨è§¦å‘ç´¢å¼•æ›´æ–°

**æ–‡ä»¶**: `python/helpers/memory_watcher.py`

**ä¾èµ–**: `watchdog` (éœ€æ·»åŠ åˆ° requirements.txt)

```python
class MemoryFileWatcher:
    """
    æ–‡ä»¶ç³»ç»Ÿç›‘æ§å™¨
    
    ç‰¹æ€§:
    - å®æ—¶æ–‡ä»¶å˜æ›´æ£€æµ‹
    - é˜²æŠ–å¤„ç†
    - å¢é‡ç´¢å¼•è§¦å‘
    """
    
    def __init__(
        self,
        memory: Memory,
        watch_dirs: List[str],
        debounce_seconds: float = 2.0,
        file_patterns: List[str] = ["*.md", "*.txt"]
    ):
        pass
    
    def start(self):
        """å¯åŠ¨ç›‘æ§"""
        pass
    
    def stop(self):
        """åœæ­¢ç›‘æ§"""
        pass
    
    async def on_file_changed(self, filepath: str, event_type: str):
        """æ–‡ä»¶å˜æ›´å›è°ƒ"""
        pass
```

**ç›‘æ§çš„ç›®å½•**:
- `knowledge/default/`
- `knowledge/custom/`
- ç”¨æˆ·é…ç½®çš„é¢å¤–ç›®å½•

**äº¤ä»˜ç‰©**:
- `memory_watcher.py` - æ–‡ä»¶ç›‘æ§
- requirements.txt æ›´æ–° (æ·»åŠ  watchdog)
- å•å…ƒæµ‹è¯•æ–‡ä»¶

---

### 4.6 é˜¶æ®µ 5: æ•´åˆæµ‹è¯• (Day 9-10)

#### 4.6.1 ç»Ÿä¸€å…¥å£

**ç›®æ ‡**: æä¾›ç»Ÿä¸€çš„å¢å¼ºè®°å¿†ç³»ç»Ÿå…¥å£

**æ–‡ä»¶**: `python/helpers/memory_enhanced.py`

```python
class EnhancedMemorySystem:
    """
    å¢å¼ºè®°å¿†ç³»ç»Ÿ - ç»Ÿä¸€å…¥å£
    
    æ•´åˆæ‰€æœ‰å¢å¼ºåŠŸèƒ½:
    - æ··åˆæ£€ç´¢
    - ä¼šè¯ç®¡ç†
    - æ–‡ä»¶ç›‘æ§
    - è®°å¿†åˆå¹¶
    - Embedding ç¼“å­˜
    """
    
    def __init__(
        self,
        agent: Agent,
        config: EnhancedMemoryConfig = None
    ):
        pass
    
    async def initialize(self):
        """åˆå§‹åŒ–æ‰€æœ‰å­ç³»ç»Ÿ"""
        pass
    
    async def save(self, text: str, area: str = "main", **metadata) -> str:
        """ä¿å­˜è®°å¿† (å¸¦æ™ºèƒ½åˆå¹¶)"""
        pass
    
    async def search(
        self,
        query: str,
        limit: int = 10,
        use_hybrid: bool = True,
        include_sessions: bool = False
    ) -> List[Document]:
        """æ™ºèƒ½æœç´¢"""
        pass
    
    async def save_conversation(self, session_id: str, role: str, content: str):
        """ä¿å­˜å¯¹è¯"""
        pass
    
    def status(self) -> Dict[str, Any]:
        """ç³»ç»ŸçŠ¶æ€"""
        pass
    
    def shutdown(self):
        """å…³é—­ç³»ç»Ÿ"""
        pass


@dataclass
class EnhancedMemoryConfig:
    """å¢å¼ºè®°å¿†ç³»ç»Ÿé…ç½®"""
    enable_hybrid: bool = True
    enable_sessions: bool = True
    enable_watcher: bool = True
    enable_consolidation: bool = True
    enable_cache: bool = True
    
    hybrid: HybridConfig = field(default_factory=HybridConfig)
    sessions: SessionConfig = field(default_factory=SessionConfig)
    cache: CacheConfig = field(default_factory=CacheConfig)
```

---

#### 4.6.2 æµ‹è¯•è®¡åˆ’

**å•å…ƒæµ‹è¯•**:

| æµ‹è¯•æ–‡ä»¶ | è¦†ç›–æ¨¡å— | æµ‹è¯•ç‚¹ |
|----------|----------|--------|
| test_memory_cache.py | memory_cache.py | ç¼“å­˜è¯»å†™ã€LRU æ¸…ç†ã€æ‰¹é‡æ“ä½œ |
| test_memory_fts.py | memory_fts.py | FTS ç´¢å¼•ã€æŸ¥è¯¢è¯­æ³•ã€BM25 æ’åº |
| test_memory_hybrid.py | memory_hybrid.py | RRF èåˆã€æ··åˆæ£€ç´¢ã€é˜ˆå€¼è¿‡æ»¤ |
| test_memory_session.py | memory_session.py | ä¼šè¯ä¿å­˜ã€å¢é‡åŒæ­¥ã€è¯­ä¹‰æœç´¢ |
| test_memory_watcher.py | memory_watcher.py | æ–‡ä»¶ç›‘æ§ã€é˜²æŠ–ã€å›è°ƒ |
| test_memory_enhanced.py | memory_enhanced.py | æ•´åˆæµ‹è¯•ã€ç«¯åˆ°ç«¯æµç¨‹ |

**é›†æˆæµ‹è¯•**:

```python
# tests/integration/test_enhanced_memory_e2e.py

async def test_full_workflow():
    """ç«¯åˆ°ç«¯æµ‹è¯•"""
    # 1. åˆå§‹åŒ–
    system = EnhancedMemorySystem(agent)
    await system.initialize()
    
    # 2. ä¿å­˜è®°å¿† (è§¦å‘åˆå¹¶)
    id1 = await system.save("Python æ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€")
    id2 = await system.save("Python æ˜¯è§£é‡Šå‹è¯­è¨€")  # åº”è¯¥è§¦å‘åˆå¹¶
    
    # 3. æ··åˆæ£€ç´¢
    results = await system.search("Python è¯­è¨€", use_hybrid=True)
    assert len(results) > 0
    
    # 4. ä¿å­˜ä¼šè¯
    await system.save_conversation("sess1", "user", "ä»€ä¹ˆæ˜¯ Python?")
    await system.save_conversation("sess1", "assistant", "Python æ˜¯...")
    
    # 5. æœç´¢ä¼šè¯
    results = await system.search("Python", include_sessions=True)
    assert any(r.metadata.get("area") == "sessions" for r in results)
    
    # 6. çŠ¶æ€æ£€æŸ¥
    status = system.status()
    assert status["hybrid"]["enabled"] == True
    assert status["cache"]["hit_rate"] > 0
    
    # 7. å…³é—­
    system.shutdown()
```

---

## 5. æ¨¡å—è¯¦ç»†è®¾è®¡

### 5.1 æ¨¡å—ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚          memory_enhanced.py (ç»Ÿä¸€å…¥å£)                              â”‚
â”‚                    â”‚                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚               â”‚               â”‚                 â”‚             â”‚
â”‚    â–¼               â–¼               â–¼                 â–¼             â”‚
â”‚ memory_       memory_         memory_           memory_            â”‚
â”‚ hybrid.py     session.py      watcher.py        consolidation.py   â”‚
â”‚    â”‚               â”‚               â”‚                 â”‚             â”‚
â”‚    â–¼               â”‚               â”‚                 â”‚             â”‚
â”‚ memory_            â”‚               â”‚                 â”‚             â”‚
â”‚ fts.py             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚    â”‚                               â”‚                               â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                    â–¼                                               â”‚
â”‚              memory.py (ç°æœ‰)                                       â”‚
â”‚                    â”‚                                               â”‚
â”‚                    â–¼                                               â”‚
â”‚              memory_cache.py                                        â”‚
â”‚              memory_sync.py                                         â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é…ç½®ç³»ç»Ÿ

**é…ç½®æ–‡ä»¶ä½ç½®**: `conf/memory_enhanced.yaml`

```yaml
# å¢å¼ºè®°å¿†ç³»ç»Ÿé…ç½®
memory_enhanced:
  enabled: true
  
  # æ··åˆæ£€ç´¢é…ç½®
  hybrid:
    enabled: true
    vector_weight: 0.7
    text_weight: 0.3
    rrf_k: 60
    candidate_multiplier: 3
  
  # ä¼šè¯ç®¡ç†é…ç½®
  sessions:
    enabled: true
    chunk_size: 10
    auto_sync: true
    sync_interval_seconds: 60
  
  # æ–‡ä»¶ç›‘æ§é…ç½®
  watcher:
    enabled: true
    debounce_seconds: 2.0
    watch_dirs:
      - "knowledge/default"
      - "knowledge/custom"
    file_patterns:
      - "*.md"
      - "*.txt"
  
  # Embedding ç¼“å­˜é…ç½®
  cache:
    enabled: true
    max_entries: 100000
    db_path: "memory/{subdir}/cache.db"
  
  # è®°å¿†åˆå¹¶é…ç½®
  consolidation:
    enabled: true
    similarity_threshold: 0.7
    replace_similarity_threshold: 0.9
    max_similar_memories: 10
```

---

## 6. æµ‹è¯•ä¸éªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½éªŒæ”¶æ ‡å‡†

| åŠŸèƒ½ | éªŒæ”¶æ ‡å‡† | æµ‹è¯•æ–¹æ³• |
|------|----------|----------|
| Embedding ç¼“å­˜ | ç¼“å­˜å‘½ä¸­æ—¶å»¶è¿Ÿ < 10ms | æ€§èƒ½æµ‹è¯• |
| FTS5 ç´¢å¼• | æ”¯æŒä¸­è‹±æ–‡æœç´¢ | åŠŸèƒ½æµ‹è¯• |
| æ··åˆæ£€ç´¢ | å¬å›ç‡æå‡ 20%+ | A/B æµ‹è¯• |
| RRF èåˆ | æ’åºç»“æœç¬¦åˆé¢„æœŸ | äººå·¥è¯„ä¼° |
| ä¼šè¯æŒä¹…åŒ– | é‡å¯åä¼šè¯å¯æ¢å¤ | åŠŸèƒ½æµ‹è¯• |
| ä¼šè¯æ£€ç´¢ | èƒ½æ£€ç´¢å†å²å¯¹è¯ | åŠŸèƒ½æµ‹è¯• |
| æ–‡ä»¶ç›‘æ§ | 2 ç§’å†…è§¦å‘ç´¢å¼• | æ€§èƒ½æµ‹è¯• |
| å¢é‡åŒæ­¥ | æœªå˜åŒ–æ–‡ä»¶ä¸é‡å»ºç´¢å¼• | æ—¥å¿—æ£€æŸ¥ |

### 6.2 æ€§èƒ½éªŒæ”¶æ ‡å‡†

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹é‡æ–¹æ³• |
|------|------|----------|
| ç¼“å­˜å‘½ä¸­ç‡ | > 60% | è¿è¡Œæ—¶ç»Ÿè®¡ |
| æ··åˆæ£€ç´¢å»¶è¿Ÿ | < 500ms | æ€§èƒ½æµ‹è¯• |
| å†…å­˜å ç”¨å¢é‡ | < 100MB | å†…å­˜ç›‘æ§ |
| å¯åŠ¨æ—¶é—´å¢é‡ | < 3s | è®¡æ—¶ |

### 6.3 å…¼å®¹æ€§éªŒæ”¶æ ‡å‡†

- [ ] ç°æœ‰ Memory ç±» API ä¸å˜
- [ ] ç°æœ‰ memory_save/memory_load å·¥å…·æ­£å¸¸å·¥ä½œ
- [ ] ç°æœ‰è®°å¿†åˆå¹¶åŠŸèƒ½æ­£å¸¸
- [ ] ä¸å½±å“ç°æœ‰ Agent è¡Œä¸º

---

## 7. é£é™©è¯„ä¼°ä¸ç¼“è§£

### 7.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| FAISS ä¸ FTS5 æ•°æ®ä¸ä¸€è‡´ | ä¸­ | é«˜ | äº‹åŠ¡æ€§æ›´æ–°ï¼Œå®šæœŸä¸€è‡´æ€§æ£€æŸ¥ |
| æ–‡ä»¶ç›‘æ§èµ„æºå ç”¨é«˜ | ä½ | ä¸­ | é™åˆ¶ç›‘æ§ç›®å½•æ•°é‡ï¼Œè®¾ç½®é˜²æŠ– |
| SQLite å¹¶å‘å†™å…¥å†²çª | ä¸­ | ä¸­ | ä½¿ç”¨ WAL æ¨¡å¼ï¼ŒåŠ é”æ§åˆ¶ |
| LLM åˆå¹¶åˆ†æè¶…æ—¶ | ä¸­ | ä½ | è®¾ç½®è¶…æ—¶ï¼Œfallback ç›´æ¥æ’å…¥ |

### 7.2 å…¼å®¹æ€§é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| ç°æœ‰ Memory API å˜æ›´ | ä½ | é«˜ | ç»§æ‰¿è€Œéä¿®æ”¹ï¼Œä¿æŒæ¥å£å…¼å®¹ |
| ä¾èµ–ç‰ˆæœ¬å†²çª | ä½ | ä¸­ | æ˜ç¡®ç‰ˆæœ¬çº¦æŸ |
| Python ç‰ˆæœ¬å…¼å®¹ | ä½ | ä¸­ | æµ‹è¯• Python 3.10+ |

---

## 8. ä¼šè¯ç­–ç•¥ (Session Policy)

> **æ–°å¢åŠŸèƒ½**: æ•´åˆè‡ª OpenClaw `src/sessions/send-policy.ts`

### 8.1 åŠŸèƒ½æè¿°

ä¼šè¯ç­–ç•¥ç³»ç»Ÿæ§åˆ¶ä¼šè¯æ¶ˆæ¯çš„å‘é€è¡Œä¸ºï¼Œæ”¯æŒæ¨¡å‹è¦†ç›–å’Œçº§åˆ«è¦†ç›–ã€‚

### 8.2 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| å‘é€ç­–ç•¥ | æ§åˆ¶æ¶ˆæ¯å‘é€æ¡ä»¶å’Œæ—¶æœº |
| æ¨¡å‹è¦†ç›– | å•ä¼šè¯æŒ‡å®šä½¿ç”¨ä¸åŒçš„ LLM æ¨¡å‹ |
| çº§åˆ«è¦†ç›– | å•ä¼šè¯è°ƒæ•´æ—¥å¿—çº§åˆ« |

### 8.3 æ•°æ®ç»“æ„

```python
@dataclass
class SessionPolicy:
    """ä¼šè¯ç­–ç•¥é…ç½®"""
    session_id: str
    
    # æ¨¡å‹è¦†ç›–
    model_override: Optional[str] = None      # å¦‚ "gpt-4o" è¦†ç›–é»˜è®¤æ¨¡å‹
    fallback_model: Optional[str] = None      # å¤‡ç”¨æ¨¡å‹
    
    # æ¶ˆæ¯å‘é€ç­–ç•¥
    send_mode: str = "default"                # default | immediate | batched | silent
    batch_size: int = 1                       # batched æ¨¡å¼ä¸‹çš„æ‰¹é‡å¤§å°
    batch_timeout: float = 5.0                # æ‰¹é‡è¶…æ—¶ (ç§’)
    
    # æ—¥å¿—è¦†ç›–
    log_level_override: Optional[str] = None  # DEBUG | INFO | WARNING | ERROR
    
    # é«˜çº§é€‰é¡¹
    max_context_messages: int = 50            # ä¸Šä¸‹æ–‡æœ€å¤§æ¶ˆæ¯æ•°
    include_system_prompt: bool = True        # æ˜¯å¦åŒ…å«ç³»ç»Ÿæç¤º
```

### 8.4 å®ç°æ–¹å¼

**æ–‡ä»¶**: `python/helpers/session_policy.py`

```python
from typing import Dict, Optional
from dataclasses import dataclass, field

@dataclass 
class SessionPolicy:
    session_id: str
    model_override: Optional[str] = None
    fallback_model: Optional[str] = None
    send_mode: str = "default"
    log_level_override: Optional[str] = None
    max_context_messages: int = 50


class SessionPolicyManager:
    """ä¼šè¯ç­–ç•¥ç®¡ç†å™¨"""
    
    def __init__(self):
        self._policies: Dict[str, SessionPolicy] = {}
        self._default_policy = SessionPolicy(session_id="__default__")
    
    def get_policy(self, session_id: str) -> SessionPolicy:
        """è·å–ä¼šè¯ç­–ç•¥"""
        return self._policies.get(session_id, self._default_policy)
    
    def set_policy(self, session_id: str, policy: SessionPolicy):
        """è®¾ç½®ä¼šè¯ç­–ç•¥"""
        self._policies[session_id] = policy
    
    def get_effective_model(self, session_id: str, default_model: str) -> str:
        """è·å–æœ‰æ•ˆæ¨¡å‹ (è€ƒè™‘è¦†ç›–)"""
        policy = self.get_policy(session_id)
        return policy.model_override or default_model
    
    def clear_policy(self, session_id: str):
        """æ¸…é™¤ä¼šè¯ç­–ç•¥"""
        self._policies.pop(session_id, None)

# å…¨å±€å®ä¾‹
_policy_manager = SessionPolicyManager()

def get_session_policy(session_id: str) -> SessionPolicy:
    return _policy_manager.get_policy(session_id)

def set_session_policy(session_id: str, **kwargs):
    policy = SessionPolicy(session_id=session_id, **kwargs)
    _policy_manager.set_policy(session_id, policy)
```

### 8.5 ä½¿ç”¨ç¤ºä¾‹

```python
# 1. è®¾ç½®æ¨¡å‹è¦†ç›–
from python.helpers.session_policy import set_session_policy

set_session_policy(
    "sess-123",
    model_override="gpt-4o",       # æ­¤ä¼šè¯ä½¿ç”¨ GPT-4o
    fallback_model="gpt-3.5-turbo" # å¤±è´¥æ—¶ç”¨ 3.5
)

# 2. è°ƒæ•´æ—¥å¿—çº§åˆ«
set_session_policy(
    "sess-456",
    log_level_override="DEBUG"     # æ­¤ä¼šè¯å¼€å¯è°ƒè¯•æ—¥å¿—
)

# 3. åœ¨ Agent ä¸­ä½¿ç”¨
policy = get_session_policy(context.session_id)
model = policy.model_override or config.default_model
```

### 8.6 ä¸ Memory ç³»ç»Ÿé›†æˆ

åœ¨ `memory_session.py` ä¸­é›†æˆç­–ç•¥:

```python
class SessionManager:
    def __init__(self):
        self.policy_manager = SessionPolicyManager()
    
    def save_message(self, session_id: str, role: str, content: str):
        policy = self.policy_manager.get_policy(session_id)
        
        # æ£€æŸ¥å‘é€æ¨¡å¼
        if policy.send_mode == "silent":
            return  # ä¸ä¿å­˜
        
        # åº”ç”¨ä¸Šä¸‹æ–‡é™åˆ¶
        self._trim_context(session_id, policy.max_context_messages)
        
        # æ­£å¸¸ä¿å­˜
        self._append_message(session_id, role, content)
```

### 8.7 é…ç½®

åœ¨ `conf/memory_enhanced.yaml` ä¸­æ·»åŠ :

```yaml
memory_enhanced:
  sessions:
    # ... ç°æœ‰é…ç½® ...
    
    # ä¼šè¯ç­–ç•¥é…ç½®
    policy:
      enabled: true
      default_send_mode: "default"
      default_max_context: 50
      allow_model_override: true
```

---

## 9. åç»­ä¼˜åŒ–æ–¹å‘

### 9.1 çŸ­æœŸä¼˜åŒ– (1-2 å‘¨)

- [ ] æ”¯æŒæ›´å¤š Embedding æ¨¡å‹ (å¦‚æœ¬åœ° BGE)
- [ ] ä¼šè¯æ‘˜è¦è‡ªåŠ¨ç”Ÿæˆ
- [ ] å¤šè¯­è¨€åˆ†è¯ä¼˜åŒ– (jieba)

### 9.2 ä¸­æœŸä¼˜åŒ– (1-2 æœˆ)

- [ ] çŸ¥è¯†å›¾è°±é›†æˆ (Neo4j/NetworkX)
- [ ] å¤šè·³æ£€ç´¢ (Multi-hop Retrieval)
- [ ] æ—¶é—´æ„ŸçŸ¥æ£€ç´¢ (Time-aware)

### 9.3 é•¿æœŸæ„¿æ™¯

- [ ] ä¸ MCP å·¥å…·é›†æˆ
- [ ] åˆ†å¸ƒå¼è®°å¿†å­˜å‚¨
- [ ] è‡ªåŠ¨çŸ¥è¯†è’¸é¦

---

## é™„å½•

### A. ä¾èµ–æ¸…å•

```
# requirements.txt æ–°å¢
watchdog>=3.0.0
```

### B. å‚è€ƒèµ„æ–™

- [OpenClaw Memory Manager](https://github.com/your-org/openclaw/blob/main/src/memory/manager.ts)
- [SQLite FTS5 Documentation](https://www.sqlite.org/fts5.html)
- [RRF Paper](https://plg.uwaterloo.ca/~gvcormac/cormacksigir09-rrf.pdf)
- [FAISS Documentation](https://faiss.ai/)

### C. å˜æ›´æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| 1.0 | 2026-01-30 | åˆå§‹ç‰ˆæœ¬ |

---

> **æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
> **æœ€åæ›´æ–°**: 2026-01-30
